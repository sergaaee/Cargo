{% extends "base.html" %}
{% load static %}
{% block title %}–ñ—É—Ä–Ω–∞–ª –ø—Ä–∏–µ–º–∫–∏{% endblock %}
{% block content %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const searchInput = document.querySelector('input[name="q"]'); // –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞
            const tableRows = document.querySelectorAll("tbody tr"); // –í—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã

            searchInput.addEventListener("input", function () {
                const query = this.value.toLowerCase().trim();

                tableRows.forEach(row => {
                    const rowText = row.innerText.toLowerCase();
                    row.style.display = rowText.includes(query) ? "" : "none";
                });
            });
        });
    </script>
    <div class="container-xxl flex-grow-1 container-p-y">
        <h4 class="py-3 mb-4"><span class="text-muted fw-light">–ü—Ä–∏–µ–º–∫–∞/</span>–ñ—É—Ä–Ω–∞–ª</h4>

        <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <form method="GET" action="">
            <div class="input-group mb-3">
                <input type="text" name="q" class="form-control"
                       aria-label="–ü–æ–∏—Å–∫ –ø–æ –ª—é–±–æ–º—É –∏–∑ –ø–æ–ª–µ–π"
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª—é–±–æ–º—É –∏–∑ –ø–æ–ª–µ–π"
                       value="{{ query|default_if_none:''|escape }}">
                <button type="submit" class="btn btn-primary">üîç</button>
            </div>
        </form>


        <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏ -->
        <form id="incoming-selection-form" method="POST" action="{% url 'deliveries:consolidation' %}">
            {% csrf_token %}
            <div class="card-datatable table-responsive">
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th><input class="form-check-input" type="checkbox" id="select-all"></th>
                        <th>
                            <a href="?q={{ query|default_if_none:''|escape }}&sort_by=tracker&order={% if sort_by == 'tracker' and order == 'asc' %}desc{% else %}asc{% endif %}">
                                –¢—Ä–µ–∫-–Ω–æ–º–µ—Ä
                            </a>
                        </th>
                        <th>
                            <a href="?q={{ query|default_if_none:''|escape }}&sort_by=tag__name&order={% if sort_by == 'tag__name' and order == 'asc' %}desc{% else %}asc{% endif %}">
                                –¢–µ–≥
                            </a>
                        </th>
                        <th>
                            <a href="?q={{ query|default_if_none:''|escape }}&sort_by=arrival_date&order={% if sort_by == 'arrival_date' and order == 'asc' %}desc{% else %}asc{% endif %}">
                                –î–∞—Ç–∞ –ø—Ä–∏–±—ã—Ç–∏—è
                            </a>
                        </th>
                        <th>
                            <a href="?q={{ query|default_if_none:''|escape }}&sort_by=inventory_numbers&order={% if sort_by == 'inventory_numbers' and order == 'asc' %}desc{% else %}asc{% endif %}">
                                –ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
                            </a>
                        </th>
                        <th>
                            <a href="?q={{ query|default_if_none:''|escape }}&sort_by=places_count&order={% if sort_by == 'places_count' and order == 'asc' %}desc{% else %}asc{% endif %}">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç
                            </a>
                        </th>
                        <th>
                            <a href="?q={{ query|default_if_none:''|escape }}&sort_by=manager&order={% if sort_by == 'client' and order == 'asc' %}desc{% else %}asc{% endif %}">
                                –ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞
                            </a>
                        </th>
                        <th>
                            <a href="?q={{ query|default_if_none:''|escape }}&sort_by=status&order={% if sort_by == 'status' and order == 'asc' %}desc{% else %}asc{% endif %}">
                                –°—Ç–∞—Ç—É—Å
                            </a>
                        </th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for incoming in page_obj %}
                        <tr>
                            {% if incoming.status == "Consolidated"%}
                                <td>
                                </td>
                            {% else %}
                                <td>
                                    <input type="checkbox" class="form-check-input" name="selected_incomings"
                                           value="{{ incoming.id }}">
                                </td>
                            {% endif %}
                            <td>
                                <ul>
                                    {% for tracker in incoming.tracker.all %}
                                        {% for code in tracker.tracking_codes.all %}
                                            {% if code.status == 'Active' %}
                                                <li>{{ code.code }}</li>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>{{ incoming.tag.name|default_if_none:"-" }}</td>
                            <td>{{ incoming.arrival_date|default_if_none:"-" }}</td>
                            <td>
                                <ul>
                                    {% for inventory_number in incoming.inventory_numbers.all %}
                                        <li>{{ inventory_number.number }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>{{ incoming.places_count|default_if_none:"-" }}</td>
                            <td>{{ incoming.client.profile.phone_number|default_if_none:"-" }}</td>
                            <td>{{ incoming.status|default_if_none:"-" }}</td>
                            <td>
                                <a href="{% url 'deliveries:detail-incoming' incoming.id %}">–ü—Ä–æ—Å–º–æ—Ç—Ä</a> |
                                <a href="{% url 'deliveries:edit-incoming' incoming.id %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a> |
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏ -->
            <button type="submit" class="btn btn-primary mt-3">–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è</button>
        </form>

        <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ -->
        <script>
            document.getElementById('select-all').addEventListener('click', function () {
                var checkboxes = document.querySelectorAll('input[name="selected_incomings"]');
                for (var checkbox of checkboxes) {
                    checkbox.checked = this.checked;
                }
            });
        </script>

        <script>
            document.getElementById('incoming-selection-form').addEventListener('submit', function (event) {
                var checkboxes = document.querySelectorAll('input[name="selected_incomings"]:checked');
                if (checkboxes.length === 0) {
                    event.preventDefault();
                    alert("–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ!");
                }
            });
        </script>

        <!-- Pagination -->
        <div class="pagination-container">
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?q={{ query|default_if_none:''|escape }}&sort_by={{ sort_by }}&order={{ order }}&page=1">&laquo; –ü–µ—Ä–≤–∞—è</a>
                    <a href="?q={{ query|default_if_none:''|escape }}&sort_by={{ sort_by }}&order={{ order }}&page={{ page_obj.previous_page_number }}">–ù–∞–∑–∞–¥</a>
                {% endif %}
                <span class="current">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}.
                </span>
                {% if page_obj.has_next %}
                    <a href="?q={{ query|default_if_none:''|escape }}&sort_by={{ sort_by }}&order={{ order }}&page={{ page_obj.next_page_number }}">–í–ø–µ—Ä—ë–¥</a>
                    <a href="?q={{ query|default_if_none:''|escape }}&sort_by={{ sort_by }}&order={{ order }}&page={{ page_obj.paginator.num_pages }}">–ü–æ—Å–ª–µ–¥–Ω—è—è &raquo;</a>
                {% endif %}
            </span>
        </div>
    </div>
{% endblock %}
